






\section{Palette tricks}

Every 1/70th of a second, the VGA output the framebuffer to the screen. Since what is stored are palette index, a translation layer is done in the VGA's DAC. The DAC convert a one byte index to a 3 bytes RGB color. The palette is stored a one block: 256*3 = 768bytes. 
CODE\\
256*3= 768 + setup out operations.\\
This palette allow for fast fading. For example when the played is taking damage, the screen briedly fades to red:
\begin{figure}[H]
  \centering
 \includegraphics[width=\textwidth]{imgs/palette_damage.png}
 \caption{The palette RGB colors altered when taking damage.} \label{fig:palette_damage}
\end{figure}
There is a trick however: Only the 3D part should fade. UpdatePaletteShifts function.\\
Palette are precomputed in 6 steps toward red or white.\\
What is fast palette setting (via outsb instruction)?\\

\begin{minipage}{\linewidth}
\lstinputlisting[language=C,morekeywords={asm,byte,far}]{code/vl_setpalette.c}
\end{minipage}


\begin{figure}[H]
  \centering
 \includegraphics[scale=1.3]{imgs/ray_caster_explained/beginning.png}
 \caption{Raycasting 1: Screenshot} \label{fig:Raycasting2Drawing}
\end{figure}

\begin{figure}[H]
  \centering
  \input{imgs/ray_caster_explained/beginning.tex}
 \caption{Raycasting 1: Drawing} \label{fig:Raycasting1}
\end{figure}




\begin{figure}[H]
  \centering
 \includegraphics[scale=1.3]{imgs/ray_caster_explained/out_door.png}
 \caption{Raycasting 2: Screenshot} \label{fig:Raycasting2Drawing}
\end{figure}

\begin{figure}[H]
\centering
 \input{imgs/ray_caster_explained/out_room.tex}
 \caption{The 320 rays cast to render the walls in the previous scene.} \label{fig:Raycasting2}
\end{figure}
 
Trivia: Actually the engine casted less than 320 rays: Trick used.
 

\section{Unrolled Loop}
Game runs at 70Hz (twice as doom which ran at 35Hz). Framerate comes from the refresh rate of VGA at 320x240. At 640*480, rate it 60hz.
\lstinputlisting[language=C]{code/unrolled_loop.c}
\lstinputlisting[language=C]{code/soundsystem_interrupt.c}


\section{Unchaining the VGA}
\subsection{Mode-X}
Mode 13: This is achieved using the VGA 'Chain 4' setting in which the lowest two bits of the 16 bit aperture address are used to select the plane to write to/read from. \footnote{https://en.wikipedia.org/wiki/Mode\_13h}
\subsection{Latch}
LatchDrawPic
Chapter 48 from michael abrash book
atches were not intended for use in 256-color mode; that was something I figured out as a hack and wrote about. The latches were used so that in 16-color mode any or all of the four planes could be written to at once.






\section{Introduction Phase}


The game starts with the "resource summary" which display the available RAM, Inputs and Audio systems. Then it is followed by the title screen and the the disclaimer screen. Subversive spirit.
TODO: Show screenshot.

\section{Renderer: Mode X and Mode Y}
As seen in the Hardware chapter, none of the VGA modes offered could do what a game needed. But game developers found

a way: Mode X \footnote{X-Mode Frequently Asked Questions - By Zoombapup (Phil)  2-Oct-94}. Nobody knows who discovered mode-X but the person who popularized it is Michael Abrash \footnote{Michael Abrash's Graphic Programming Black Book: Chapter 47, page 877.}. The idea is to disable the "convenience" mechanism making the 4 banks appear as one. It is called putting the VGA in unchained mode where each bank of memory (called "plane") is written to individually.\\
With this technique the 64KB of mapped RAM can access the full 256KB of the VGA. This enables a mode offering:
\begin{itemize}
	\item Resolution of 320x200
	\item Double buffering
	\item Storage of sprites in VRAM.
\end{itemize}

Compared to figure 
TODO: New Drawing of VGA RAM.\\
But there is still a problem: Switching the target RAM was very slow. So a routine drawing an horizontal line on the screen:

\begin{verbatim}
void DrawLine(y, color) {
  for(int x=0; x < 320 ; x++) {
    SelectBrank(x % 4);
    WritePixel(x, y, color);   
  }
}
\end{verbatim}\\
Would have been unpractical. But something else can be done if you notice that 320 is a multiple of 4 (320/4=80): If you draw only columns you don't have to change the target plan often.\\
TOOD: Drawing of how column line up in VGA RAM.\\





\subsection{Writing multiple pixels}
In the Hardware chapter we introduced the VGA bank system:
\begin{figure}[H]
\centering
\includegraphics[scale=0.5]{imgs/vga_ram_screen_layout.eps}
\end{figure}

Even though it was convoluted it allows clever tricks. Let's take the example of clearing the screen to black. A naive approach would be to write every pixels left to write and top to bottom:

\lstinputlisting[language=C]{code/vga_clear/naive.c}


The cost of this operation is 320x200= 64000 writes and 64000 out operation (to select the mask).
But the overhead of selecting the bank (a.k.a plan) would make the task impossibly slow. A better approach would be to do bottom up and left to right as follow:

\lstinputlisting[language=C]{code/vga_clear/optimized.c}

The code is slightly more complicated but this way we only switch bank XXX times and write 320x200=64000 writes and  320 out out operation. But there is a way to do even better: 

\lstinputlisting[language=C]{code/vga_clear/optimal.c}

Which results in 320*80=25600 and 1 out operation !\\

This is not always that easy: You can write up to four pixels in one write as long as they are properly aligned. See the example following:
\begin{figure}[H]
  \centering
 \includegraphics[scale=0.3]{imgs//vga_multiple_pixel_write.png}
\end{figure}





















  
  
\subsection{Why a raytracer instead of a rasterizer?} 
\begin{fancyquotes}
Much was made about the "ray casting" used in Wolfenstein, but the real reason for it was that I had a lot of trouble with wall-span rendering in Catacombs 3D.  C3D (and Hovertank before that) shipped with various graphics glitches that you could get in some combinations of map block configurations, position, and viewing angle.  Some were due to fixed point precision issues not being handled optimally, and some were due to clipping and culling issues that I didn't really get a handle on until a couple years later.  In any case, they bothered me a lot.  Spurious graphics glitches do a lot of harm to the sense of immersion in a game, and I very much wanted Id games to feel "rock solid".
 \bigskip \\
There was a clear performance cost to it - doing 320 traces through a tile map and treating each column independently is much slower than looping through a few long wall segments.  However, the resulting code was small and very regular compared to the hairball of my wall span renderers, and it did deliver the rock-solid feel I wanted.
 \bigskip \\
If you made extremely jagged block maps that would turn into many dozen independent wall segments, the ray casting could start to look like a good performance choice, but few scenes were even close to that.  This is exactly the same ray tracing versus rasterization performance tradeoff that is still being made today, but now it is "how many tens of millions of triangles per frame to ray tracing break-even" instead of "how many dozen wall segments".
 \bigskip \\
\textbf{John Carmack - Programmer}
 \end{fancyquotes}
 
 
 
 
 
 
 
 \subsection{Things compression}
 If wall texture were always fully opaque (64*64 sprites), things could be transparent. So they were good candidate to save space in RAM. They are stored compressed in RAM and decompressed on the fly when they have to be drawn. As a result they are stored as column of pixels (instead of the usual lines of pixels you can find in BMP or PNG formats).
 
 \subsubsection{Example: Soldier} 
 \subsubsection{Example: Lamp}  
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 \subsection{Page flipping trick}
 Use an address that can be changed with only one byte ( e.g: a000 b0000 c000).
 Or did he wait for the vsync?
\section{I.A: State Machines} 

Defined in WL\_ACT2.c\\
Normal, standing guard\\
Walking guard\\
Deaf guard\\

Planes:
=Ambush tile: enemy placed ohere are deaf to all attacks (normal enemy responds immediately to sound).\\
An ambush tile-affected enemy is not blind but attack playe but won't react to dead soldiers or dogs.\\


\section{Pseudo random generator}
US\_RndT\\
rndtable\\
During dying randon generation is done differently.

\section{Heathbeats}
VGA: 70Hz
audio: Depends on quality, three levels of fidelity.

\section{Music and Sound effects} 

